diff -up openssh-4.3p2/auth2-pubkey.c.fips openssh-4.3p2/auth2-pubkey.c
--- openssh-4.3p2/auth2-pubkey.c.fips	2004-12-11 03:39:50.000000000 +0100
+++ openssh-4.3p2/auth2-pubkey.c	2009-05-15 18:26:05.000000000 +0200
@@ -25,6 +25,8 @@
 #include "includes.h"
 RCSID("$OpenBSD: auth2-pubkey.c,v 1.9 2004/12/11 01:48:56 dtucker Exp $");
 
+#include <openssl/fips.h>
+
 #include "ssh.h"
 #include "ssh2.h"
 #include "xmalloc.h"
@@ -240,7 +242,7 @@ user_key_allowed2(struct passwd *pw, Key
 			found_key = 1;
 			debug("matching key found: file %s, line %lu",
 			    file, linenum);
-			fp = key_fingerprint(found, SSH_FP_MD5, SSH_FP_HEX);
+			fp = key_fingerprint(found, FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5, SSH_FP_HEX);
 			verbose("Found matching %s key: %s",
 			    key_type(found), fp);
 			xfree(fp);
diff -up openssh-4.3p2/authfile.c.fips openssh-4.3p2/authfile.c
--- openssh-4.3p2/authfile.c.fips	2005-06-17 04:59:35.000000000 +0200
+++ openssh-4.3p2/authfile.c	2009-05-15 19:36:29.000000000 +0200
@@ -131,8 +131,14 @@ key_save_private_rsa1(Key *key, const ch
 	/* Allocate space for the private part of the key in the buffer. */
 	cp = buffer_append_space(&encrypted, buffer_len(&buffer));
 
-	cipher_set_key_string(&ciphercontext, cipher, passphrase,
-	    CIPHER_ENCRYPT);
+	if (cipher_set_key_string(&ciphercontext, cipher, passphrase,
+	    CIPHER_ENCRYPT) < 0) {
+	    error("cipher_set_key_string failed.");
+	    buffer_free(&encrypted);
+	    buffer_free(&buffer);
+	    return 0;
+	}
+
 	cipher_crypt(&ciphercontext, cp,
 	    buffer_ptr(&buffer), buffer_len(&buffer));
 	cipher_cleanup(&ciphercontext);
@@ -404,8 +410,14 @@ key_load_private_rsa1(int fd, const char
 	cp = buffer_append_space(&decrypted, buffer_len(&buffer));
 
 	/* Rest of the buffer is encrypted.  Decrypt it using the passphrase. */
-	cipher_set_key_string(&ciphercontext, cipher, passphrase,
-	    CIPHER_DECRYPT);
+	if (cipher_set_key_string(&ciphercontext, cipher, passphrase,
+	    CIPHER_DECRYPT) < 0) {
+	    error("cipher_set_key_string failed.");
+	    buffer_free(&decrypted);
+	    buffer_free(&buffer);
+	    goto fail;
+	}
+
 	cipher_crypt(&ciphercontext, cp,
 	    buffer_ptr(&buffer), buffer_len(&buffer));
 	cipher_cleanup(&ciphercontext);
diff -up openssh-4.3p2/cipher.c.fips openssh-4.3p2/cipher.c
--- openssh-4.3p2/cipher.c.fips	2006-02-13 15:05:18.000000000 +0100
+++ openssh-4.3p2/cipher.c	2009-05-15 19:37:32.000000000 +0200
@@ -42,6 +42,7 @@ RCSID("$OpenBSD: cipher.c,v 1.77 2005/07
 #include "cipher.h"
 
 #include <openssl/md5.h>
+#include <openssl/fips.h>
 
 /* compatibility with old or broken OpenSSL versions */
 #include "openbsd-compat/openssl-compat.h"
@@ -87,6 +88,22 @@ struct Cipher {
 	{ NULL,			SSH_CIPHER_INVALID, 0, 0, 0, NULL }
 };
 
+struct Cipher fips_ciphers[] = {
+	{ "none",		SSH_CIPHER_NONE, 8, 0, 0, EVP_enc_null },
+	{ "3des",		SSH_CIPHER_3DES, 8, 16, 0, evp_ssh1_3des },
+
+	{ "3des-cbc",		SSH_CIPHER_SSH2, 8, 24, 0, EVP_des_ede3_cbc },
+	{ "aes128-cbc",		SSH_CIPHER_SSH2, 16, 16, 0, EVP_aes_128_cbc },
+	{ "aes192-cbc",		SSH_CIPHER_SSH2, 16, 24, 0, EVP_aes_192_cbc },
+	{ "aes256-cbc",		SSH_CIPHER_SSH2, 16, 32, 0, EVP_aes_256_cbc },
+	{ "rijndael-cbc@lysator.liu.se",
+				SSH_CIPHER_SSH2, 16, 32, 0, EVP_aes_256_cbc },
+	{ "aes128-ctr",		SSH_CIPHER_SSH2, 16, 16, 0, evp_aes_128_ctr },
+	{ "aes192-ctr",		SSH_CIPHER_SSH2, 16, 24, 0, evp_aes_128_ctr },
+	{ "aes256-ctr",		SSH_CIPHER_SSH2, 16, 32, 0, evp_aes_128_ctr },
+	{ NULL,			SSH_CIPHER_INVALID, 0, 0, 0, NULL }
+};
+
 /*--*/
 
 u_int
@@ -123,7 +140,7 @@ Cipher *
 cipher_by_name(const char *name)
 {
 	Cipher *c;
-	for (c = ciphers; c->name != NULL; c++)
+	for (c = FIPS_mode() ? fips_ciphers : ciphers; c->name != NULL; c++)
 		if (strcmp(c->name, name) == 0)
 			return c;
 	return NULL;
@@ -133,7 +150,7 @@ Cipher *
 cipher_by_number(int id)
 {
 	Cipher *c;
-	for (c = ciphers; c->name != NULL; c++)
+	for (c = FIPS_mode() ? fips_ciphers : ciphers; c->name != NULL; c++)
 		if (c->number == id)
 			return c;
 	return NULL;
@@ -177,7 +194,7 @@ cipher_number(const char *name)
 	Cipher *c;
 	if (name == NULL)
 		return -1;
-	for (c = ciphers; c->name != NULL; c++)
+	for (c = FIPS_mode() ? fips_ciphers : ciphers; c->name != NULL; c++)
 		if (strcasecmp(c->name, name) == 0)
 			return c->number;
 	return -1;
@@ -284,14 +301,15 @@ cipher_cleanup(CipherContext *cc)
  * passphrase and using the resulting 16 bytes as the key.
  */
 
-void
+int
 cipher_set_key_string(CipherContext *cc, Cipher *cipher,
     const char *passphrase, int do_encrypt)
 {
 	MD5_CTX md;
 	u_char digest[16];
 
-	MD5_Init(&md);
+	if (MD5_Init(&md) <= 0)
+		return -1;
 	MD5_Update(&md, (const u_char *)passphrase, strlen(passphrase));
 	MD5_Final(digest, &md);
 
@@ -299,6 +317,7 @@ cipher_set_key_string(CipherContext *cc,
 
 	memset(digest, 0, sizeof(digest));
 	memset(&md, 0, sizeof(md));
+	return 0;
 }
 
 /*
diff -up openssh-4.3p2/cipher-ctr.c.fips openssh-4.3p2/cipher-ctr.c
--- openssh-4.3p2/cipher-ctr.c.fips	2005-12-19 07:40:40.000000000 +0100
+++ openssh-4.3p2/cipher-ctr.c	2009-05-15 18:26:05.000000000 +0200
@@ -141,7 +141,8 @@ evp_aes_128_ctr(void)
 	aes_ctr.do_cipher = ssh_aes_ctr;
 #ifndef SSH_OLD_EVP
 	aes_ctr.flags = EVP_CIPH_CBC_MODE | EVP_CIPH_VARIABLE_LENGTH |
-	    EVP_CIPH_ALWAYS_CALL_INIT | EVP_CIPH_CUSTOM_IV;
+	    EVP_CIPH_ALWAYS_CALL_INIT | EVP_CIPH_CUSTOM_IV |
+	    EVP_CIPH_FLAG_FIPS;
 #endif
 	return (&aes_ctr);
 }
diff -up openssh-4.3p2/cipher.h.fips openssh-4.3p2/cipher.h
--- openssh-4.3p2/cipher.h.fips	2004-08-12 14:40:25.000000000 +0200
+++ openssh-4.3p2/cipher.h	2009-05-15 19:37:53.000000000 +0200
@@ -78,7 +78,7 @@ void	 cipher_init(CipherContext *, Ciphe
     const u_char *, u_int, int);
 void	 cipher_crypt(CipherContext *, u_char *, const u_char *, u_int);
 void	 cipher_cleanup(CipherContext *);
-void	 cipher_set_key_string(CipherContext *, Cipher *, const char *, int);
+int	 cipher_set_key_string(CipherContext *, Cipher *, const char *, int);
 u_int	 cipher_blocksize(const Cipher *);
 u_int	 cipher_keylen(const Cipher *);
 
diff -up openssh-4.3p2/mac.c.fips openssh-4.3p2/mac.c
--- openssh-4.3p2/mac.c.fips	2005-06-17 04:59:35.000000000 +0200
+++ openssh-4.3p2/mac.c	2009-05-15 18:26:05.000000000 +0200
@@ -26,6 +26,7 @@
 RCSID("$OpenBSD: mac.c,v 1.7 2005/06/17 02:44:32 djm Exp $");
 
 #include <openssl/hmac.h>
+#include <openssl/fips.h>
 
 #include "xmalloc.h"
 #include "getput.h"
@@ -34,11 +35,11 @@ RCSID("$OpenBSD: mac.c,v 1.7 2005/06/17 
 #include "kex.h"
 #include "mac.h"
 
-struct {
+struct Macs {
 	char		*name;
 	const EVP_MD *	(*mdfunc)(void);
 	int		truncatebits;	/* truncate digest if != 0 */
-} macs[] = {
+} all_macs[] = {
 	{ "hmac-sha1",			EVP_sha1, 0, },
 	{ "hmac-sha1-96",		EVP_sha1, 96 },
 	{ "hmac-md5",			EVP_md5, 0 },
@@ -48,10 +49,16 @@ struct {
 	{ NULL,				NULL, 0 }
 };
 
+struct Macs fips_macs[] = {
+	{ "hmac-sha1",			EVP_sha1, 0 },
+	{ NULL,				NULL, 0 }
+};
+
 int
 mac_init(Mac *mac, char *name)
 {
 	int i, evp_len;
+	struct Macs *macs = FIPS_mode() ? fips_macs : all_macs;
 
 	for (i = 0; macs[i].name; i++) {
 		if (strcmp(name, macs[i].name) == 0) {
diff -up openssh-4.3p2/Makefile.in.fips openssh-4.3p2/Makefile.in
--- openssh-4.3p2/Makefile.in.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/Makefile.in	2009-05-15 18:26:05.000000000 +0200
@@ -135,28 +135,28 @@ libssh.a: $(LIBSSH_OBJS)
 	$(RANLIB) $@
 
 ssh$(EXEEXT): $(LIBCOMPAT) libssh.a $(SSHOBJS)
-	$(LD) -o $@ $(SSHOBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS)
+	$(LD) -o $@ $(SSHOBJS) $(LDFLAGS) -lssh -lopenbsd-compat -lfipscheck $(LIBS)
 
 sshd$(EXEEXT): libssh.a	$(LIBCOMPAT) $(SSHDOBJS)
-	$(LD) -o $@ $(SSHDOBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(LIBWRAP) $(LIBPAM) $(LIBSELINUX) $(LIBAUDIT) $(LIBS)
+	$(LD) -o $@ $(SSHDOBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(LIBWRAP) $(LIBPAM) $(LIBSELINUX) $(LIBAUDIT) -lfipscheck $(LIBS)
 
 scp$(EXEEXT): $(LIBCOMPAT) libssh.a scp.o progressmeter.o
 	$(LD) -o $@ scp.o progressmeter.o bufaux.o $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS)
 
 ssh-add$(EXEEXT): $(LIBCOMPAT) libssh.a ssh-add.o
-	$(LD) -o $@ ssh-add.o $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS)
+	$(LD) -o $@ ssh-add.o $(LDFLAGS) -lssh -lopenbsd-compat -lfipscheck $(LIBS)
 
 ssh-agent$(EXEEXT): $(LIBCOMPAT) libssh.a ssh-agent.o
-	$(LD) -o $@ ssh-agent.o $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS)
+	$(LD) -o $@ ssh-agent.o $(LDFLAGS) -lssh -lopenbsd-compat -lfipscheck $(LIBS)
 
 ssh-keygen$(EXEEXT): $(LIBCOMPAT) libssh.a ssh-keygen.o
-	$(LD) -o $@ ssh-keygen.o $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS)
+	$(LD) -o $@ ssh-keygen.o $(LDFLAGS) -lssh -lopenbsd-compat -lfipscheck $(LIBS)
 
 ssh-keysign$(EXEEXT): $(LIBCOMPAT) libssh.a ssh-keysign.o
-	$(LD) -o $@ ssh-keysign.o readconf.o $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS)
+	$(LD) -o $@ ssh-keysign.o readconf.o $(LDFLAGS) -lssh -lopenbsd-compat -lfipscheck $(LIBS)
 
 ssh-keyscan$(EXEEXT): $(LIBCOMPAT) libssh.a ssh-keyscan.o
-	$(LD) -o $@ ssh-keyscan.o $(LDFLAGS) -lssh -lopenbsd-compat -lssh $(LIBS)
+	$(LD) -o $@ ssh-keyscan.o $(LDFLAGS) -lssh -lopenbsd-compat -lssh -lfipscheck $(LIBS)
 
 sftp-server$(EXEEXT): $(LIBCOMPAT) libssh.a sftp.o sftp-common.o sftp-server.o
 	$(LD) -o $@ sftp-server.o sftp-common.o $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS)
diff -up openssh-4.3p2/myproposal.h.fips openssh-4.3p2/myproposal.h
--- openssh-4.3p2/myproposal.h.fips	2005-07-26 13:54:56.000000000 +0200
+++ openssh-4.3p2/myproposal.h	2009-05-15 18:26:05.000000000 +0200
@@ -38,7 +38,12 @@
 	"hmac-sha1-96,hmac-md5-96"
 #define	KEX_DEFAULT_COMP	"none,zlib@openssh.com,zlib"
 #define	KEX_DEFAULT_LANG	""
-
+#define	KEX_FIPS_ENCRYPT \
+	"aes128-ctr,aes192-ctr,aes256-ctr," \
+	"aes128-cbc,3des-cbc," \
+	"aes192-cbc,aes256-cbc,rijndael-cbc@lysator.liu.se"
+#define	KEX_FIPS_MAC \
+	"hmac-sha1"
 
 static char *myproposal[PROPOSAL_MAX] = {
 	KEX_DEFAULT_KEX,
diff -up openssh-4.3p2/nsskeys.c.fips openssh-4.3p2/nsskeys.c
--- openssh-4.3p2/nsskeys.c.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/nsskeys.c	2009-05-15 18:26:05.000000000 +0200
@@ -183,8 +183,8 @@ nss_convert_pubkey(Key *k)
 			break;
 	}
 
-	p = key_fingerprint(k, SSH_FP_MD5, SSH_FP_HEX);
-	debug("fingerprint %u %s", key_size(k), p);
+	p = key_fingerprint(k, SSH_FP_SHA1, SSH_FP_HEX);
+	debug("SHA1 fingerprint %u %s", key_size(k), p);
 	xfree(p);
 
 	return 0;
diff -up openssh-4.3p2/openbsd-compat/bsd-arc4random.c.fips openssh-4.3p2/openbsd-compat/bsd-arc4random.c
--- openssh-4.3p2/openbsd-compat/bsd-arc4random.c.fips	2005-02-16 03:01:28.000000000 +0100
+++ openssh-4.3p2/openbsd-compat/bsd-arc4random.c	2009-05-15 18:26:05.000000000 +0200
@@ -34,6 +34,7 @@ RCSID("$Id: bsd-arc4random.c,v 1.10 2005
 static int rc4_ready = 0;
 static RC4_KEY rc4;
 
+#if 0
 unsigned int
 arc4random(void)
 {
@@ -77,4 +78,30 @@ arc4random_stir(void)
 
 	rc4_ready = REKEY_BYTES;
 }
+#else
+unsigned int
+arc4random(void)
+{
+	unsigned int r = 0;
+	void *rp = &r;
+
+	if (!rc4_ready) {
+		arc4random_stir();
+	}
+	RAND_bytes(rp, sizeof(r));
+
+	return(r);
+}
+
+void
+arc4random_stir(void)
+{
+	unsigned char rand_buf[SEED_SIZE];
+
+	if (RAND_bytes(rand_buf, sizeof(rand_buf)) <= 0)
+		fatal("Couldn't obtain random bytes (error %ld)",
+		    ERR_get_error());
+	rc4_ready = 1;
+}
+#endif
 #endif /* !HAVE_ARC4RANDOM */
diff -up openssh-4.3p2/ssh-add.c.fips openssh-4.3p2/ssh-add.c
--- openssh-4.3p2/ssh-add.c.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/ssh-add.c	2009-05-15 18:26:05.000000000 +0200
@@ -38,6 +38,7 @@
 RCSID("$OpenBSD: ssh-add.c,v 1.74 2005/11/12 18:37:59 deraadt Exp $");
 
 #include <openssl/evp.h>
+#include <openssl/fips.h>
 
 #ifdef HAVE_LIBNSS
 #include <nss.h>
@@ -230,7 +231,7 @@ list_identities(AuthenticationConnection
 		    key = ssh_get_next_identity(ac, &comment, version)) {
 			had_identities = 1;
 			if (do_fp) {
-				fp = key_fingerprint(key, SSH_FP_MD5,
+				fp = key_fingerprint(key, FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5,
 				    SSH_FP_HEX);
 				printf("%d %s %s (%s)\n",
 				    key_size(key), fp, comment, key_type(key));
diff -up openssh-4.3p2/ssh-agent.c.fips openssh-4.3p2/ssh-agent.c
--- openssh-4.3p2/ssh-agent.c.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/ssh-agent.c	2009-05-15 18:26:05.000000000 +0200
@@ -39,6 +39,7 @@ RCSID("$OpenBSD: ssh-agent.c,v 1.124 200
 
 #include <openssl/evp.h>
 #include <openssl/md5.h>
+#include <openssl/fips.h>
 
 #include "ssh.h"
 #include "rsa.h"
@@ -175,9 +176,9 @@ confirm_key(Identity *id)
 	char *p;
 	int ret = -1;
 
-	p = key_fingerprint(id->key, SSH_FP_MD5, SSH_FP_HEX);
-	if (ask_permission("Allow use of key %s?\nKey fingerprint %s.",
-	    id->comment, p))
+	p = key_fingerprint(id->key, FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5, SSH_FP_HEX);
+	if (ask_permission("Allow use of key %s?\nKey %sfingerprint %s.",
+	    id->comment, FIPS_mode() ? "SHA1 " : "", p))
 		ret = 0;
 	xfree(p);
 
diff -up openssh-4.3p2/ssh.c.fips openssh-4.3p2/ssh.c
--- openssh-4.3p2/ssh.c.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/ssh.c	2009-05-15 19:39:41.000000000 +0200
@@ -44,6 +44,8 @@ RCSID("$OpenBSD: ssh.c,v 1.257 2005/12/2
 
 #include <openssl/evp.h>
 #include <openssl/err.h>
+#include <openssl/fips.h>
+#include <fipscheck.h>
 
 #include "ssh.h"
 #include "ssh1.h"
@@ -195,6 +197,10 @@ main(int ac, char **av)
 	sanitise_stdfd();
 
 	__progname = ssh_get_progname(av[0]);
+	SSLeay_add_all_algorithms();
+	if (FIPS_mode() && !FIPSCHECK_verify(NULL, NULL)) {
+		fatal("FIPS integrity verification test failed.");
+	}
 	init_rng();
 
 	/*
@@ -250,6 +256,9 @@ again:
 	    "1246ab:c:e:fgi:kl:m:no:p:qstvxACD:F:I:L:MNO:PR:S:TVw:XY")) != -1) {
 		switch (opt) {
 		case '1':
+			if (FIPS_mode()) {
+				fatal("Protocol 1 not allowed in the FIPS mode.");
+			}
 			options.protocol = SSH_PROTO_1;
 			break;
 		case '2':
@@ -528,7 +537,6 @@ again:
 	if (!host)
 		usage();
 
-	SSLeay_add_all_algorithms();
 	ERR_load_crypto_strings();
 
 	/* Initialize the command to execute on remote host. */
@@ -609,6 +617,10 @@ again:
 
 	seed_rng();
 
+	if (FIPS_mode()) {
+		logit("FIPS mode initialized");
+	}
+
 	if (options.user == NULL)
 		options.user = xstrdup(pw->pw_name);
 
@@ -648,6 +660,12 @@ again:
 	if (options.control_path != NULL)
 		control_client(options.control_path);
 
+	if (FIPS_mode()) {
+		options.protocol &= SSH_PROTO_2;
+		if (options.protocol == 0)
+			fatal("Protocol 2 disabled by configuration but required in the FIPS mode.");
+	}
+
 	/* Open a connection to the remote host. */
 	if (ssh_connect(host, &hostaddr, options.port,
 	    options.address_family, options.connection_attempts,
diff -up openssh-4.3p2/sshconnect2.c.fips openssh-4.3p2/sshconnect2.c
--- openssh-4.3p2/sshconnect2.c.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/sshconnect2.c	2009-05-15 18:26:05.000000000 +0200
@@ -25,6 +25,8 @@
 #include "includes.h"
 RCSID("$OpenBSD: sshconnect2.c,v 1.143 2005/10/14 02:17:59 stevesk Exp $");
 
+#include <openssl/fips.h>
+
 #include "openbsd-compat/sys-queue.h"
 
 #include "ssh.h"
@@ -94,6 +96,10 @@ ssh_kex2(char *host, struct sockaddr *ho
 	if (options.ciphers != NULL) {
 		myproposal[PROPOSAL_ENC_ALGS_CTOS] =
 		myproposal[PROPOSAL_ENC_ALGS_STOC] = options.ciphers;
+	} else if (FIPS_mode()) {
+		myproposal[PROPOSAL_ENC_ALGS_CTOS] =
+		myproposal[PROPOSAL_ENC_ALGS_STOC] = KEX_FIPS_ENCRYPT;
+
 	}
 	myproposal[PROPOSAL_ENC_ALGS_CTOS] =
 	    compat_cipher_proposal(myproposal[PROPOSAL_ENC_ALGS_CTOS]);
@@ -109,7 +115,11 @@ ssh_kex2(char *host, struct sockaddr *ho
 	if (options.macs != NULL) {
 		myproposal[PROPOSAL_MAC_ALGS_CTOS] =
 		myproposal[PROPOSAL_MAC_ALGS_STOC] = options.macs;
+	} else if (FIPS_mode()) {
+		myproposal[PROPOSAL_MAC_ALGS_CTOS] =
+		myproposal[PROPOSAL_MAC_ALGS_STOC] = KEX_FIPS_MAC;
 	}
+
 	if (options.hostkeyalgorithms != NULL)
 		myproposal[PROPOSAL_SERVER_HOST_KEY_ALGS] =
 		    options.hostkeyalgorithms;
@@ -450,8 +460,8 @@ input_userauth_pk_ok(int type, u_int32_t
 		    key->type, pktype);
 		goto done;
 	}
-	fp = key_fingerprint(key, SSH_FP_MD5, SSH_FP_HEX);
-	debug2("input_userauth_pk_ok: fp %s", fp);
+	fp = key_fingerprint(key, SSH_FP_SHA1, SSH_FP_HEX);
+	debug2("input_userauth_pk_ok: SHA1 fp %s", fp);
 	xfree(fp);
 
 	/*
diff -up openssh-4.3p2/sshconnect.c.fips openssh-4.3p2/sshconnect.c
--- openssh-4.3p2/sshconnect.c.fips	2005-12-13 09:29:03.000000000 +0100
+++ openssh-4.3p2/sshconnect.c	2009-05-15 18:26:05.000000000 +0200
@@ -16,6 +16,7 @@
 RCSID("$OpenBSD: sshconnect.c,v 1.171 2005/12/06 22:38:27 reyk Exp $");
 
 #include <openssl/bn.h>
+#include <openssl/fips.h>
 
 #include "ssh.h"
 #include "xmalloc.h"
@@ -684,7 +685,7 @@ check_host_key(char *host, struct sockad
 			else
 				snprintf(msg1, sizeof(msg1), ".");
 			/* The default */
-			fp = key_fingerprint(host_key, SSH_FP_MD5, SSH_FP_HEX);
+			fp = key_fingerprint(host_key, FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5, SSH_FP_HEX);
 			msg2[0] = '\0';
 			if (options.verify_host_key_dns) {
 				if (matching_host_key_dns)
@@ -699,10 +700,10 @@ check_host_key(char *host, struct sockad
 			snprintf(msg, sizeof(msg),
 			    "The authenticity of host '%.200s (%s)' can't be "
 			    "established%s\n"
-			    "%s key fingerprint is %s.\n%s"
+			    "%s key %sfingerprint is %s.\n%s"
 			    "Are you sure you want to continue connecting "
 			    "(yes/no)? ",
-			    host, ip, msg1, type, fp, msg2);
+			    host, ip, msg1, type, FIPS_mode() ? "SHA1 " : "", fp, msg2);
 			xfree(fp);
 			if (!confirm(msg))
 				goto fail;
@@ -969,12 +970,12 @@ show_key_from_file(const char *file, con
 	found = key_new(keytype);
 	if ((ret = lookup_key_in_hostfile_by_type(file, host,
 	    keytype, found, &line))) {
-		fp = key_fingerprint(found, SSH_FP_MD5, SSH_FP_HEX);
+		fp = key_fingerprint(found, FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5, SSH_FP_HEX);
 		logit("WARNING: %s key found for host %s\n"
 		    "in %s:%d\n"
-		    "%s key fingerprint %s.",
+		    "%s key %sfingerprint %s.",
 		    key_type(found), host, file, line,
-		    key_type(found), fp);
+		    key_type(found), FIPS_mode() ? "SHA1 ":"", fp);
 		xfree(fp);
 	}
 	key_free(found);
@@ -1020,7 +1021,7 @@ warn_changed_key(Key *host_key)
 	char *fp;
 	const char *type = key_type(host_key);
 
-	fp = key_fingerprint(host_key, SSH_FP_MD5, SSH_FP_HEX);
+	fp = key_fingerprint(host_key, FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5, SSH_FP_HEX);
 
 	error("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
 	error("@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @");
@@ -1028,8 +1029,8 @@ warn_changed_key(Key *host_key)
 	error("IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!");
 	error("Someone could be eavesdropping on you right now (man-in-the-middle attack)!");
 	error("It is also possible that the %s host key has just been changed.", type);
-	error("The fingerprint for the %s key sent by the remote host is\n%s.",
-	    type, fp);
+	error("The %sfingerprint for the %s key sent by the remote host is\n%s.",
+	    FIPS_mode() ? "SHA1 ":"", type, fp);
 	error("Please contact your system administrator.");
 
 	xfree(fp);
diff -up openssh-4.3p2/sshd.c.fips openssh-4.3p2/sshd.c
--- openssh-4.3p2/sshd.c.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/sshd.c	2009-05-15 19:41:15.000000000 +0200
@@ -48,6 +48,8 @@ RCSID("$OpenBSD: sshd.c,v 1.318 2005/12/
 #include <openssl/bn.h>
 #include <openssl/md5.h>
 #include <openssl/rand.h>
+#include <openssl/fips.h>
+#include <fipscheck.h>
 #ifdef HAVE_SECUREWARE
 #include <sys/security.h>
 #include <prot.h>
@@ -899,6 +901,11 @@ main(int ac, char **av)
 	(void)set_auth_parameters(ac, av);
 #endif
 	__progname = ssh_get_progname(av[0]);
+
+	SSLeay_add_all_algorithms();
+	if (FIPS_mode() && !FIPSCHECK_verify(NULL, NULL)) {
+		fatal("FIPS integrity verification test failed.");
+	}
 	init_rng();
 
 	/* Save argv. Duplicate so setproctitle emulation doesn't clobber it */
@@ -1031,8 +1038,6 @@ main(int ac, char **av)
 	else
 		closefrom(REEXEC_DEVCRYPTO_RESERVED_FD);
 
-	SSLeay_add_all_algorithms();
-
 	/*
 	 * Force logging to stderr until we have loaded the private host
 	 * key (unless started from inetd)
@@ -1130,6 +1135,10 @@ main(int ac, char **av)
 		debug("private host key: #%d type %d %s", i, key->type,
 		    key_type(key));
 	}
+	if ((options.protocol & SSH_PROTO_1) && FIPS_mode()) {
+		logit("Disabling protocol version 1. Not allowed in the FIPS mode.");
+		options.protocol &= ~SSH_PROTO_1;
+	}
 	if ((options.protocol & SSH_PROTO_1) && !sensitive_data.have_ssh1_key) {
 		logit("Disabling protocol version 1. Could not load host key");
 		options.protocol &= ~SSH_PROTO_1;
@@ -1244,6 +1253,10 @@ main(int ac, char **av)
 	/* Initialize the random number generator. */
 	arc4random_stir();
 
+	if (FIPS_mode()) {
+		logit("FIPS mode initialized");
+	}
+
 	/* Chdir to the root directory so that the current disk can be
 	   unmounted if desired. */
 	chdir("/");
@@ -2030,6 +2043,9 @@ do_ssh2_kex(void)
 	if (options.ciphers != NULL) {
 		myproposal[PROPOSAL_ENC_ALGS_CTOS] =
 		myproposal[PROPOSAL_ENC_ALGS_STOC] = options.ciphers;
+	} else if (FIPS_mode()) {
+		myproposal[PROPOSAL_ENC_ALGS_CTOS] =
+		myproposal[PROPOSAL_ENC_ALGS_STOC] = KEX_FIPS_ENCRYPT;
 	}
 	myproposal[PROPOSAL_ENC_ALGS_CTOS] =
 	    compat_cipher_proposal(myproposal[PROPOSAL_ENC_ALGS_CTOS]);
@@ -2039,6 +2055,9 @@ do_ssh2_kex(void)
 	if (options.macs != NULL) {
 		myproposal[PROPOSAL_MAC_ALGS_CTOS] =
 		myproposal[PROPOSAL_MAC_ALGS_STOC] = options.macs;
+	} else if (FIPS_mode()) {
+		myproposal[PROPOSAL_MAC_ALGS_CTOS] =
+		myproposal[PROPOSAL_MAC_ALGS_STOC] = KEX_FIPS_MAC;
 	}
 	if (options.compression == COMP_NONE) {
 		myproposal[PROPOSAL_COMP_ALGS_CTOS] =
diff -up openssh-4.3p2/ssh-keygen.c.fips openssh-4.3p2/ssh-keygen.c
--- openssh-4.3p2/ssh-keygen.c.fips	2009-05-15 18:26:05.000000000 +0200
+++ openssh-4.3p2/ssh-keygen.c	2009-05-15 18:26:05.000000000 +0200
@@ -16,6 +16,7 @@ RCSID("$OpenBSD: ssh-keygen.c,v 1.135 20
 
 #include <openssl/evp.h>
 #include <openssl/pem.h>
+#include <openssl/fips.h>
 
 #include "xmalloc.h"
 #include "key.h"
@@ -492,7 +493,7 @@ do_fingerprint(struct passwd *pw)
 	enum fp_type fptype;
 	struct stat st;
 
-	fptype = print_bubblebabble ? SSH_FP_SHA1 : SSH_FP_MD5;
+	fptype = print_bubblebabble ? SSH_FP_SHA1 : FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5;
 	rep =    print_bubblebabble ? SSH_FP_BUBBLEBABBLE : SSH_FP_HEX;
 
 	if (!have_identity)
@@ -1408,10 +1409,10 @@ passphrase_again:
 	fclose(f);
 
 	if (!quiet) {
-		char *fp = key_fingerprint(public, SSH_FP_MD5, SSH_FP_HEX);
+		char *fp = key_fingerprint(public, FIPS_mode() ? SSH_FP_SHA1 : SSH_FP_MD5, SSH_FP_HEX);
 		printf("Your public key has been saved in %s.\n",
 		    identity_file);
-		printf("The key fingerprint is:\n");
+		printf("The key %sfingerprint is:\n", FIPS_mode() ? "SHA1 " : "");
 		printf("%s %s\n", fp, comment);
 		xfree(fp);
 	}
